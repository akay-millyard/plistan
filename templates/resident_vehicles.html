{% extends "base.html" %}
{% block content %}
<div class="stack">

  <div class="card" style="max-width:720px">
    <h2>Min parkering · {{ household.name }}</h2>
    <p class="muted">Max boendefordon: <strong>{{ max_resident }}</strong> • Max gästtimmar: <strong>{{ max_hours }}</strong></p>

    {% if vehicles|length < max_resident %}
      <form method="post"
            action="{{ url_for('resident_add_vehicle') }}?t={{ tenant_slug }}&hid={{ household.id }}"
            class="stack"
            id="addForm"
            autocomplete="off">
        <div class="row" style="gap:12px; flex-wrap:wrap;">
          <div style="flex:1; min-width:220px">
            <label for="reg">Registreringsnummer</label>
            <input id="reg"
                   name="reg"
                   placeholder="ABC123 eller ABC12A"
                   required
                   pattern="^[A-Za-zÅÄÖåäö]{3}(?:\d{3}|\d{2}[A-Za-zÅÄÖåäö])$"
                   title="Tre bokstäver + tre siffror, eller två siffror + en bokstav. Ex: ABC123 eller ABC12A">
            <small class="muted">Mellanslag/streck ignoreras, vi konverterar till versaler automatiskt.</small>
          </div>
          <div style="min-width:220px">
            <label for="ownership_type">Typ</label>
            <select id="ownership_type" name="ownership_type" required>
              <option value="egen">Egenägd</option>
              <option value="företag">Företagsbil</option>
              <option value="lånad">Lånad</option>
              <option value="hyrbil">Hyrbil</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary" type="submit">+ Lägg till fordon</button>
      </form>
    {% else %}
      <div class="badge">Du har nått max {{ max_resident }} registrerade fordon.</div>
    {% endif %}

    <div class="stack" style="margin-top:14px">
      {% if vehicles|length %}
        <ul class="list">
          {% for v in vehicles %}
          <li class="row" style="justify-content:space-between; align-items:center;">
            <div class="row" style="gap:10px; align-items:center;">
              <strong style="letter-spacing:.06em">{{ v['reg'] }}</strong>
              {% if v['ownership_type'] %}<span class="badge">{{ v['ownership_type'] }}</span>{% endif %}
              {% if v['type']=='guest' and v['valid_to'] %}
                <span class="badge">gäst till {{ v['valid_to'] }}</span>
              {% endif %}
            </div>

            {% if v['type']=='resident' %}
            <form method="post"
                  action="{{ url_for('resident_delete_vehicle', vehicle_id=v['id']) }}?t={{ tenant_slug }}&hid={{ household.id }}"
                  onsubmit="return askReason(this);">
              <input type="hidden" name="reason" value="">
              <button class="btn btn-ghost" type="submit">Ta bort</button>
            </form>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="muted">Inga registrerade boendefordon ännu.</div>
      {% endif %}
    </div>
  </div>

  <div class="card" style="max-width:720px">
    <h3>Gästlänk & QR</h3>
    <form method="post"
          action="{{ url_for('resident_new_guest_link') }}?t={{ tenant_slug }}&hid={{ household.id }}"
          class="row" style="gap:12px; flex-wrap:wrap;">
      <div>
        <label for="hours">Giltighet (timmar)</label>
        <input id="hours" name="hours" type="number" min="1" max="{{ max_hours }}" value="{{ max_hours }}" required>
        <small class="muted">Max {{ max_hours }} timmar enligt föreningens regler.</small>
      </div>
      <button class="btn btn-primary" type="submit" id="guestBtn">Skapa gästlänk</button>
    </form>

    {% if guest_link %}
      <div class="row" style="gap:10px; align-items:center; margin-top:10px;">
        <a class="btn" id="guestLink" href="{{ guest_link }}" target="_blank" rel="noopener">Öppna gästlänk</a>
        <button class="btn btn-ghost" type="button" onclick="copyHref('#guestLink')">Kopiera länk</button>
      </div>
      {% if qr_svg %}
        <div style="margin-top:10px">{{ qr_svg|safe }}</div>
      {% endif %}
    {% endif %}
  </div>

</div>

<style>
.list { list-style:none; padding-left:0; margin:0; }
#reg{ text-transform:uppercase; letter-spacing:.08em; font-weight:700; }
</style>

<script>
(function(){
  // auto uppercase + ta bort mellanslag/streck
  const reg = document.getElementById('reg');
  if (reg){
    reg.addEventListener('input', () => {
      let v = reg.value.replace(/[\s-]/g,'').toUpperCase();
      if (v.length > 7) v = v.slice(0,7);
      reg.value = v;
    });
  }

  // disable på gästknappen för att hindra dubbel-submit
  const gbtn = document.getElementById('guestBtn');
  if (gbtn){
    gbtn.form?.addEventListener('submit', () => {
      gbtn.disabled = true; gbtn.textContent = 'Skapar...';
      setTimeout(()=>{ gbtn.disabled=false; gbtn.textContent='Skapa gästlänk'; }, 5000);
    });
  }
})();

function askReason(formEl){
  const reason = prompt('Ange orsak till borttagning (krävs):', 'Byter fordon');
  if (!reason) return false;
  formEl.querySelector('input[name="reason"]').value = reason;
  return true;
}

function copyHref(sel){
  const el = document.querySelector(sel);
  if(!el) return;
  const href = el.getAttribute('href');
  navigator.clipboard?.writeText(href).then(()=>toast('Länk kopierad!')).catch(()=>fallbackCopy(href));
}
function fallbackCopy(text){
  const ta = document.createElement('textarea');
  ta.value = text; document.body.appendChild(ta);
  ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
  toast('Kopierat.');
}
function toast(msg){
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.position='fixed'; t.style.bottom='20px'; t.style.left='50%';
  t.style.transform='translateX(-50%)'; t.style.padding='8px 12px';
  t.style.background='var(--ink)'; t.style.color='#fff';
  t.style.borderRadius='10px'; t.style.boxShadow='var(--shadow)';
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 1400);
}
</script>
{% endblock %}
