{% extends "base.html" %}
{% block content %}
<div class="stack">

  <div class="card" style="max-width:640px">
    <h2>Kontroll / Status</h2>
    <form method="get" class="row" id="statusForm" autocomplete="off" style="gap:12px; flex-wrap:wrap;">
      <input type="hidden" name="t" value="{{ tenant_slug }}">
      <div style="flex:1; min-width:240px">
        <label for="reg">Registreringsnummer</label>
        <input id="reg"
               name="reg"
               value="{{ reg or '' }}"
               placeholder="ABC123 eller ABC12A"
               autofocus
               inputmode="latin"
               autocapitalize="characters"
               pattern="^[A-Za-zÅÄÖåäö]{3}(?:\d{3}|\d{2}[A-Za-zÅÄÖåäö])$"
               title="Tre bokstäver + tre siffror, eller två siffror + en bokstav">
        <small class="muted">Mellanslag/streck ignoreras. Vi konverterar till versaler automatiskt.</small>
      </div>
      <button class="btn btn-primary" type="submit" id="checkBtn">Kontrollera</button>

      <!-- (Valfritt) QR-skanning om kontrollanten har QR-kod som innehåller regnumret -->
      <button class="btn btn-ghost" type="button" id="scanBtn">Skanna QR</button>
    </form>

    <div id="scanWrap" class="scan-wrap" hidden>
      <video id="video" playsinline muted></video>
      <div class="scan-tip">Rikta mot QR-koden…</div>
      <button class="btn" type="button" id="stopBtn" style="margin-top:8px;">Stoppa skanning</button>
    </div>

    {% if result %}
      <div class="status-box {{ result['status'] }}" style="margin-top:16px">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div>
            <div class="badge {{ result['status'] }}">{{ result['status']|capitalize }}</div>
            {% if result['type'] %}<span class="badge light">{{ result['type'] }}</span>{% endif %}
          </div>
          {% if reg %}<strong style="letter-spacing:.06em">{{ reg }}</strong>{% endif %}
        </div>
        <div class="stack" style="margin-top:8px">
          {% if result['household'] %}<div>Hushåll: <strong>{{ result['household'] }}</strong></div>{% endif %}
          {% if result['valid_to'] %}<div>Giltig till: <strong>{{ result['valid_to'] }}</strong></div>{% endif %}
          {% if result['status']=='unknown' %}<div class="muted">Ingen träff i listan.</div>{% endif %}
        </div>
      </div>
    {% endif %}
  </div>

</div>

<style>
.status-box{ padding:12px; border-radius:12px; background:#f6f7f9; }
.status-box.allowed{ background:rgba(0,160,80,.08); border:1px solid rgba(0,160,80,.25); }
.status-box.expired{ background:rgba(220,160,0,.08); border:1px solid rgba(220,160,0,.25); }
.status-box.unknown{ background:rgba(110,120,130,.08); border:1px solid rgba(110,120,130,.25); }
.badge.light{ background:#eef1f4; color:#39424e; }
.badge.allowed{ background:#19a974; color:#fff; }
.badge.expired{ background:#c38f00; color:#fff; }
.badge.unknown{ background:#6b7280; color:#fff; }
#reg{ text-transform:uppercase; font-weight:700; letter-spacing:.08em; }

/* QR-scan area */
.scan-wrap{
  margin-top:10px; border-radius:12px; overflow:hidden;
  border:1px solid #e5e7eb; position:relative;
}
#video{ width:100%; max-height:320px; background:#000; }
.scan-tip{
  position:absolute; left:12px; bottom:12px; background:rgba(0,0,0,.55);
  color:#fff; padding:6px 8px; border-radius:8px; font-size:.9em;
}
</style>

<script>
(function(){
  const reg = document.getElementById('reg');
  const form = document.getElementById('statusForm');
  const btn  = document.getElementById('checkBtn');

  // Auto-uppercase och städa bort tecken
  if (reg){
    reg.addEventListener('input', () => {
      let v = reg.value.replace(/[\s-]/g,'').toUpperCase();
      if (v.length > 7) v = v.slice(0,7);
      reg.value = v;
    });
  }

  // Dubbelklick-skydd
  form?.addEventListener('submit', () => {
    btn.disabled = true; btn.textContent = 'Kontrollerar…';
    setTimeout(()=>{ btn.disabled=false; btn.textContent='Kontrollera'; }, 3000);
  });

  // ---- QR-skanning (med fallback) ----
  const scanBtn = document.getElementById('scanBtn');
  const stopBtn = document.getElementById('stopBtn');
  const wrap = document.getElementById('scanWrap');
  const video = document.getElementById('video');
  let stream, rafId, detector, zxingReader;

  async function startScan(){
    // Försök native BarcodeDetector först
    if ('BarcodeDetector' in window) {
      try {
        detector = new BarcodeDetector({ formats: ['qr_code'] });
        await startCamera();
        tickNative();
        return;
      } catch(e) {
        console.warn('BarcodeDetector error, fall back to ZXing', e);
      }
    }
    // Fallback: ZXing via CDN (laddas bara när det behövs)
    await loadZXing();
    await startCamera();
    await startZXing();
  }

  function stopScan(){
    wrap.hidden = true;
    cancelAnimationFrame(rafId);
    video.pause();
    if (stream){ stream.getTracks().forEach(t => t.stop()); }
    if (zxingReader){ try { zxingReader.reset(); } catch(_){} }
  }

  async function startCamera(){
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    await video.play();
    wrap.hidden = false;
  }

  // Native-läsning
  async function tickNative(){
    try{
      const codes = await detector.detect(video);
      if (codes && codes.length){
        handlePayload(codes[0].rawValue || '');
        return;
      }
    }catch(e){}
    rafId = requestAnimationFrame(tickNative);
  }

  // ZXing fallback
  async function loadZXing(){
    if (window.ZXingBrowser) return;
    await new Promise((res, rej)=>{
      const s = document.createElement('script');
      s.src = 'https://unpkg.com/@zxing/browser@latest';
      s.onload = res; s.onerror = rej;
      document.head.appendChild(s);
    });
  }

  async function startZXing(){
    const { BrowserMultiFormatReader, NotFoundException } = ZXingBrowser;
    zxingReader = new BrowserMultiFormatReader();
    // Välj rätt videostream (vi använder redan getUserMedia till <video>)
    const videoInputDevices = await zxingReader.listVideoInputDevices();
    const deviceId = (videoInputDevices.find(d => /back|rear/i.test(d.label)) || videoInputDevices[0] || {}).deviceId;
    // Om vi redan spelar upp video via getUserMedia räcker det att be ZXing läsa från elementet:
    zxingReader.decodeFromVideoElement(video, (result, err) => {
      if (result && result.getText){
        handlePayload(result.getText());
      } else if (err && !(err instanceof NotFoundException)) {
        console.warn(err);
      }
    }, deviceId);
  }

  function handlePayload(text){
    const payload = (text || '').trim().toUpperCase();
    // Hitta regnr inne i strängen/länken
    const match = payload.match(/[A-ZÅÄÖ]{3}(?:\d{3}|\d{2}[A-ZÅÄÖ])/);
    if (match){
      reg.value = match[0];
      stopScan();
      form.submit();
    } else {
      // Om QR-koden bara är en länk utan regnr – öppna den i ny flik (valfritt)
      try {
        if (/^https?:\/\//i.test(payload)) window.open(payload, '_blank', 'noopener');
      } catch(_){}
      toast('QR hittad men inget regnr.');
    }
  }

  scanBtn?.addEventListener('click', startScan);
  stopBtn?.addEventListener('click', stopScan);

  // Små hjälpare
  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.position='fixed'; t.style.bottom='20px'; t.style.left='50%';
    t.style.transform='translateX(-50%)'; t.style.padding='8px 12px';
    t.style.background='var(--ink,#111)'; t.style.color='#fff';
    t.style.borderRadius='10px'; t.style.boxShadow='0 6px 20px rgba(0,0,0,.2)';
    document.body.appendChild(t);
    setTimeout(()=>t.remove(), 1600);
  }
})();
</script>
{% endblock %}
